<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Case Evaluation</title>
    <link rel="stylesheet" href="/static/css/index.css">
</head>
<body>
    <div class="header">
        <h1>Test Case Evaluation Interface</h1>
    </div>
    
    {% for metric_name, intervals in samples_by_metric.items() %}
    <div class="metric-section">
        <h2>{{ metric_name }}</h2>
        
        {% for interval, test_cases in intervals.items() %}
        <div class="interval-section">
            <div class="interval-header">
                Score Interval: {{ interval }}
            </div>
            
            {% if test_cases %}
                {% for test_case in test_cases %}
                <div class="test-case">
                    <!-- Test Case Header -->
                    <div class="test-case-header">
                        <div class="field-group">
                            <h3>Score</h3>
                            <div class="field-content">
                                <p><span class="score">{{ "%.2f"|format(test_case.metric.score) }}</span></p>
                            </div>
                        </div>

                        <div class="field-group">
                            <h3>Input</h3>
                            <div class="field-content">
                                <p>{{ test_case.input }}</p>
                            </div>
                        </div>

                        <div class="field-group">
                            <h3>Actual Output</h3>
                            <div class="field-content">
                                <p>{{ test_case.actualOutput }}</p>
                            </div>
                        </div>

                        <div class="field-group">
                            <h3>Expected Output</h3>
                            <div class="field-content">
                                <p>{{ test_case.expectedOutput }}</p>
                            </div>
                        </div>

                        <div class="field-group">
                            <h3>Retrieval Contexts</h3>
                            <div class="retrieval-contexts">
                                {% for context in test_case.retrievalContext %}
                                    <div class="context-item">{{ context }}</div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <!-- Analysis Section -->
                    <div class="metric">
                        <h4>Analysis</h4>
                        <p>Reason: {{ test_case.metric.reason }}</p>
                        
                        <div class="detailed-analysis">
                            {% set log_data = test_case.metric.verboseLogs|parse_verbose_logs %}

                             <!-- Debug output -->
                            <div style="background: #f0f0f0; padding: 10px; margin: 10px 0; font-family: monospace;">
                                <p>Metric Name: {{ metric_name }}</p>
                                <p>Raw Logs: <pre>{{ test_case.metric.verboseLogs }}</pre></p>
                                <p>Has Log Data: {{ log_data is defined }}</p>
                                <p>Has Statements: {{ log_data.statements|default([])|length > 0 }}</p>
                                <p>Has Verdicts: {{ log_data.verdicts|default([])|length > 0 }}</p>
                                <p>Number of Statements: {{ log_data.statements|default([])|length }}</p>
                                <p>Number of Verdicts: {{ log_data.verdicts|default([])|length }}</p>
                                <p>Parsed Statements: {{ log_data.statements|default([]) }}</p>
                                <p>Parsed Verdicts: {{ log_data.verdicts|default([]) }}</p>
                            </div>


                            {% if metric_name == "Answer Relevancy" %}
                            <h5>Statement Analysis</h5>
                                {% if log_data.statements %}
                                    {% for statement in log_data.statements %}
                                    <div class="verdict-item">
                                        <div class="statement">Statement: {{ statement }}</div>
                                        {% if log_data.verdicts and loop.index0 < log_data.verdicts|length %}
                                            <div class="verdict">
                                                <div>Verdict: {{ log_data.verdicts[loop.index0].verdict }}</div>
                                                <div class="verdict-status">
                                                    {% if log_data.verdicts[loop.index0].verdict == "yes" %}
                                                        ✓ Accepted
                                                    {% else %}
                                                        ✗ Rejected
                                                    {% endif %}
                                                </div>
                                            </div>
                                            
                                            <div class="feedback-buttons">
                                                <button class="agree" 
                                                    data-metric="{{ metric_name }}"
                                                    data-interval="{{ interval }}"
                                                    data-case-index="{{ loop.index0 }}"
                                                    data-item-id="statement_{{ loop.index0 }}">
                                                    Agree with Verdict
                                                </button>
                                                <button class="disagree"
                                                    data-metric="{{ metric_name }}"
                                                    data-interval="{{ interval }}"
                                                    data-case-index="{{ loop.index0 }}"
                                                    data-item-id="statement_{{ loop.index0 }}">
                                                    Disagree with Verdict
                                                </button>
                                            </div>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="no-samples">No statements found for analysis</div>
                                {% endif %}
                            {% endif %}

                            {% if metric_name == "Faithfulness" %}
                                <h5>Claim Analysis</h5>
                                {% if log_data.claims %}
                                    {% for claim in log_data.claims %}
                                    <div class="verdict-item">
                                        <div class="claim">Claim: {{ claim }}</div>
                                        {% if log_data.verdicts and loop.index0 < log_data.verdicts|length %}
                                            <div class="verdict">
                                                <div>Verdict: {{ log_data.verdicts[loop.index0].verdict }}</div>
                                                <div class="verdict-status">
                                                    {% if log_data.verdicts[loop.index0].verdict == "yes" %}
                                                        ✓ Accepted
                                                    {% else %}
                                                        ✗ Rejected
                                                    {% endif %}
                                                </div>
                                            </div>
                                            
                                            <div class="feedback-buttons">
                                                <button class="agree" 
                                                    data-metric="{{ metric_name }}"
                                                    data-interval="{{ interval }}"
                                                    data-case-index="{{ loop.index0 }}"
                                                    data-item-id="claim_{{ loop.index0 }}">
                                                    Agree with Verdict
                                                </button>
                                                <button class="disagree"
                                                    data-metric="{{ metric_name }}"
                                                    data-interval="{{ interval }}"
                                                    data-case-index="{{ loop.index0 }}"
                                                    data-item-id="claim_{{ loop.index0 }}">
                                                    Disagree with Verdict
                                                </button>
                                            </div>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="no-samples">No test cases found in this interval</div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% endfor %}

    <!-- Statistics Section -->
    <div class="statistics-section">
        <h2>Feedback Statistics</h2>
        
        <div class="stats-grid">
            <div class="stats-card">
                <h3>Overall Agreement Rate</h3>
                <div class="stats-value" id="overall-agreement">-</div>
                <div class="stats-detail">
                    <span id="total-agrees">0</span> agrees / <span id="total-verdicts">0</span> total verdicts
                </div>
            </div>

            <div class="stats-card">
                <h3>Agreement by Metric</h3>
                <div class="stats-list" id="metric-stats"></div>
            </div>

            <div class="stats-card">
                <h3>Agreement by Interval</h3>
                <div class="stats-list" id="interval-stats"></div>
            </div>
        </div>
    </div>

    <script src="/static/js/feedback.js"></script>
</body>
</html>